---
title: 'docker buildx bakeã§è¤‡æ•°ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä¸¦åˆ—ã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹'
emoji: 'ğŸ³'
type: 'tech'
topics:
  - 'docker'
  - 'buildx'
  - 'container'
published: true
published_at: '2021-08-21 19:24'
---

# æ¦‚è¦

ã‹ã¤ã¦ã€Docker ã§ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†ã“ã¨ã¯ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚2017 å¹´ã«å°å…¥ã•ã‚ŒãŸ multi-stage build ã§ã¯ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸãŒã€ã‚ãã¾ã§ã‚‚**ä¸€ã¤ã®ã‚¤ãƒ¡ãƒ¼ã‚¸**ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹éç¨‹ã§ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ä¸¦åˆ—å®Ÿè¡Œã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã—ãŸã€‚

ã—ã‹ã—ã€buildx ã®æ–°æ©Ÿèƒ½ã§ã‚ã‚‹`buildx bake`ã‚’ä½¿ã†ã¨ã€ä¸€ã¤ã®ã‚³ãƒãƒ³ãƒ‰ã§**è¤‡æ•°ã®ã‚¤ãƒ¡ãƒ¼ã‚¸**ã‚’åŒæ™‚ã«ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€ä»¥ä¸‹ã®`Dockerfile`ã‹ã‚‰`microservice-a`ã¨`microservice-b`ã® 2 ã¤ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```dockerfile
# Microservice Aã¨Bã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¸
FROM rust as builder-stage

COPY ./src /services-src

WORKDIR /services-src
RUN cargo build --release --bins

# Microservice Aã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã‚’ç”¨æ„ã™ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¸
FROM debian:bullseye-slim as microservice-a-stage

RUN apt-get update && \
    apt-get install -y service-a-dependencies && \
    rm -rf /var/lib/apt/lists/*

COPY --from=builder-stage /services-src/target/release/service-a /service-a

ENTRYPOINT ["/service-a"]

# Microservice Bã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã‚’ç”¨æ„ã™ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¸
FROM debian:bullseye-slim as microservice-b-stage

RUN apt-get update && \
    apt-get install -y service-b-dependencies && \
    rm -rf /var/lib/apt/lists/*

COPY --from=builder-stage /services-src/target/release/service-b /service-b

ENTRYPOINT ["/service-b"]
```

ã“ã®è¨˜äº‹ã§ã¯ä¸Šè¨˜ã®`Dockerfile`ã‚’ä¾‹ã«ã¨ã‚Šã€`buildx bake`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦è¤‡æ•°ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä¸¦åˆ—ã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

```mermaid
graph TB
    A(builder stage) -->|copy files| B(microservice-a stage)
    A -->|copy files| C(microservice-b stage)
    subgraph pharallel [ä¸¦åˆ—å®Ÿè¡Œ]
    B -->|tag image| D>microservice-a image]
    C -->|tag image| E>microservice-a image]
    end
```

:::message
`buildx bake`ã®ä»•æ§˜ã¯ç¢ºå®šã—ã¦ãŠã‚‰ãšã€å¾Œæ–¹äº’æ›æ€§ã®ãªã„å¤‰æ›´ãŒå…¥ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æœ€æ–°ã®æƒ…å ±ã¯[ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://github.com/docker/buildx/blob/master/docs/reference/buildx_bake.md)ã§ã”ç¢ºèªãã ã•ã„ã€‚
:::

# ãƒ“ãƒ«ãƒ‰å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«

`buildx bake`ã‚’ä½¿ã†ã«ã¯ã€ã¾ãšãƒ“ãƒ«ãƒ‰å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å†’é ­ã§ç¤ºã—ãŸ`Dockerfile`ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«`docker-bake.hcl`ã‚’æ›¸ãã¾ã™ã€‚

```hcl
target "microservice-a" {
  dockerfile = "Dockerfile" # Dockerfileã®ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãªã®ã§çœç•¥å¯èƒ½ï¼‰
  target = "microservice-a-stage" # ã‚¹ãƒ†ãƒ¼ã‚¸åï¼ˆç´›ã‚‰ã‚ã—ã„ãŒã€2è¡Œä¸Šã®targetã¨ã¯ç„¡é–¢ä¿‚ï¼‰
  tags = ["ciffelia/microservice-a"] # ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã¤ã‘ã‚‹ã‚¿ã‚°ï¼ˆè¤‡æ•°å¯ï¼‰
}

target "microservice-b" {
  dockerfile = "Dockerfile"
  target = "microservice-b-stage"
  tags = ["ciffelia/microservice-b"]
}
```

ãƒ“ãƒ«ãƒ‰å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯è¤‡æ•°ã® target ã‚’å®šç¾©ã§ãã¾ã™ã€‚target ã®ä¸­ã§ã¯ã€`docker build`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã¨åŒã˜ã‚ˆã†ã«ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚
å¾“æ¥ã¯ã€1 å›ã®`docker build`ã§ 1 ã¤ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ã„ã¾ã—ãŸã€‚`buildx bake`ã§ã¯ã€1 ã¤ã® target ã§ 1 ã¤ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚

```mermaid
graph LR
    subgraph new [docker buildx bake]
    G($ docker buildx bake) --> H([target A])
    G --> I([target B])
    G --> J([target C])
    subgraph def [defined in docker-bake.hcl]
    H --> K[image A]
    I --> L[image B]
    J --> M[image C]
    end
    end
    subgraph old [docker build]
    A($ docker build ...) --> B[image A]
    C($ docker build ...) --> D[image B]
    E($ docker build ...) --> F[image C]
    end
```

ãªãŠã€å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨˜æ³•ã¯ä»¥ä¸‹ã® 3 ã¤ã®ä¸­ã‹ã‚‰é¸ã¶ã“ã¨ãŒã§ãã¾ã™ã€‚

- Docker Compose (`docker-compose.yml`ã®`build`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«æ›¸ã)
- HCL (HashiCorp configuration language)
- JSON

å€‹äººçš„ã«ã¯`docker-compose.yml`ã®è‚¥å¤§åŒ–ã‚’é¿ã‘ãŸã„ã®ã§ã€ãƒ“ãƒ«ãƒ‰å®šç¾©ã¯ HCL ã‹ JSON ã«æ›¸ãã®ãŒè‰¯ã„ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚JSON ã‚’æ‰‹ã§æ›¸ãã®ã¯å¤§å¤‰ãªã®ã§ã€ã“ã®è¨˜äº‹ã§ã¯ HCL ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

# `buildx bake`ã‚³ãƒãƒ³ãƒ‰

`buildx bake`ã¯ã€äºˆã‚ç”¨æ„ã—ã¦ãŠã„ãŸãƒ“ãƒ«ãƒ‰å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã«åŸºã¥ã„ã¦ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€å…ˆç¨‹ç¤ºã—ãŸ`docker-bake.hcl`ã®`microservice-a` `microservice-b` target ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

```shell
docker buildx bake --file docker-bake.hcl microservice-a microservice-b
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ 1 ã¤ã§ã€`ciffelia/microservice-a`ã¨`ciffelia/microservice-b`ã® 2 ã¤ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒä½œæˆã•ã‚Œã¾ã™ã€‚ã¾ãŸã€3 ã¤ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ä¸¦åˆ—ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

# ä¾¿åˆ©ãªæ©Ÿèƒ½

ã“ã“ã‹ã‚‰ã¯ã€`buildx bake`ã‚’ä½¿ã†ä¸Šã§ä¾¿åˆ©ãªæ©Ÿèƒ½ã‚’ã„ãã¤ã‹ç´¹ä»‹ã—ã¾ã™ã€‚

## Target options

target ã®ä¸­ã§æŒ‡å®šã§ãã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€
`args`, `cache-from`, `cache-to`, `context`, `dockerfile`, `inherits`, `labels`, `no-cache`, `output`, `platform`, `pull`, `secrets`, `ssh`, `tags`, `target`
ã§ã™ã€‚ä½¿ã„æ–¹ã¯åŸºæœ¬çš„ã«`docker buildx build`ã¨åŒã˜ã§ã™ã€‚

```hcl
target "example" {
  dockerfile = "docker/Dockerfile.webapp"
  tags = ["ciffelia/webapp"]
  cache-from = ["type=registry,ref=ciffelia/webapp"] # äº‹å‰ã«ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‹ã‚‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’pullã™ã‚‹
  push = true # ãƒ“ãƒ«ãƒ‰å®Œäº†å¾Œã€ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«pushã™ã‚‹
}
```

## Groups

è¤‡æ•°ã® target ã‚’ã¾ã¨ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```hcl
group "default" {
  targets = ["microservice-a", "microservice-b"]
}

target "microservice-a" {
  target = "microservice-a-stage"
  tags = ["ciffelia/microservice-a"]
}

target "microservice-b" {
  target = "microservice-b-stage"
  tags = ["ciffelia/microservice-b"]
}
```

ä¸Šè¨˜ã®ã‚ˆã†ã«`docker-bake.hcl`ã‚’æ›¸ã„ã¦ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚Œã°ã€`microservice-a`ã¨`microservice-b`ã® 2 ã¤ã® target ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```shell
docker buildx bake --file docker-bake.hcl default
```

ãªãŠã€å®Ÿè¡Œã—ãŸã„ target ã‚„ group ã®åå‰ãŒ`default`ã®å ´åˆã¯çœç•¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```shell
# åŒã˜çµæœãŒå¾—ã‚‰ã‚Œã‚‹
docker buildx bake --file docker-bake.hcl
```

## ç¶™æ‰¿

`inherits`ã‚’ä½¿ã†ã¨ã€æ—¢å­˜ã® target ã‚’ã‚‚ã¨ã«æ–°ã—ã„ target ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```hcl
target "microservice-a" {
  target = "microservice-a-stage"
  tags = ["ciffelia/microservice-a"]
}

target "microservice-a-multiarch" {
  inherits = ["microservice-a"]
  platforms = ["linux/amd64", "linux/arm64/v8", "linux/arm/v7"]
}
```

## è¤‡æ•°ã® Dockerfile

1 ã¤ã®`docker-bake.hcl`ã§è¤‡æ•°ã®`Dockerfile`ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚å½“ç„¶ã€ä¸¦åˆ—ã§ãƒ“ãƒ«ãƒ‰ã•ã‚Œã¾ã™ã€‚

```hcl
target "frontend" {
  dockerfile = "docker/Dockerfile.frontend"
  tags = ["ciffelia/my-frontend"]
}

target "backend" {
  dockerfile = "docker/Dockerfile.backend"
  tags = ["ciffelia/my-backend"]
}
```

## GitHub Action

`buildx bake`ã‚’å®Ÿè¡Œã™ã‚‹ GitHub Action ãŒã€Docker å…¬å¼ã§ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://github.com/docker/bake-action

# Reference

- [High-level build options](https://github.com/docker/buildx#high-level-build-options)
- [buildx bake](https://github.com/docker/buildx/blob/master/docs/reference/buildx_bake.md)
